name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Base version (e.g., 4.6.5) - revision auto-added if needed'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  # ============================================================================
  # DETERMINE VERSION
  # ============================================================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            BASE="${{ github.event.inputs.version }}"
            # Check if revision needed
            VERSION=$(python3 build/version-manager.py --get-next --base "$BASE" --quiet 2>/dev/null || echo "$BASE")
            TAG="v$VERSION"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION (Tag: $TAG)"

  # ============================================================================
  # BUILD PACKAGES
  # ============================================================================
  build:
    name: Build
    needs: prepare
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.prepare.outputs.version }}

  # ============================================================================
  # CREATE RELEASE
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, build]
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist
          merge-multiple: true

      - name: List artifacts
        run: ls -la ./dist/

      - name: Generate release notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          cat << 'EOF' > release_notes.md
          ## ðŸ“¦ Runtipi $VERSION for ASUSTOR
          
          ### Downloads
          
          | Architecture | Package | Models |
          |--------------|---------|--------|
          | **x86-64** | `io.runtipi_$VERSION_x86-64.apk` | AS65xx, AS66xx, AS67xx, AS52xx, AS53xx, AS54xx, AS70xx, Lockerstor, Flashstor |
          | **ARM64** | `io.runtipi_$VERSION_arm64.apk` | AS33xx, AS11xx, Drivestor |
          
          ### Installation
          
          1. Download the `.apk` for your NAS architecture
          2. Go to **App Central** â†’ **Manual Install**
          3. Select the downloaded file
          
          ### Requirements
          
          - ADM 5.1.0+
          - Docker CE 28.1.1+
          - jq 1.7.1+
          - Git 2.45.2+
          - 4GB RAM (8GB recommended)
          
          ### Checksums
          
          ```
          EOF
          cat dist/checksums.sha256 >> release_notes.md 2>/dev/null || echo "N/A" >> release_notes.md
          echo '```' >> release_notes.md
          
          # Substitute version
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Runtipi ${{ needs.prepare.outputs.version }} for ASUSTOR
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          files: |
            dist/*.apk
            dist/checksums.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
