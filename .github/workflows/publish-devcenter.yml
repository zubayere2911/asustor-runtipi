name: Publish to Dev Center

on:
  release:
    types: [released]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (empty = latest)'
        type: string
      skip_upload:
        description: 'Skip auto-upload (manual only)'
        type: boolean
        default: false

jobs:
  publish:
    name: Build & Publish
    runs-on: ubuntu-latest
    if: ${{ !github.event.release.prerelease || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install requests beautifulsoup4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(python3 -c "import json; print(json.load(open('apk/CONTROL/config.json'))['general']['version'])")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build packages
        run: |
          python3 build/build.py
          python3 build/build-arm64.py
          cd apk/bin && sha256sum *.apk > checksums.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: asustor-packages-${{ steps.version.outputs.version }}
          path: |
            apk/bin/*.apk
            apk/bin/checksums.sha256
          retention-days: 90

      - name: Auto-upload (experimental)
        id: upload
        if: ${{ github.event.inputs.skip_upload != 'true' }}
        continue-on-error: true
        env:
          ASUSTOR_USERNAME: ${{ secrets.ASUSTOR_USERNAME }}
          ASUSTOR_PASSWORD: ${{ secrets.ASUSTOR_PASSWORD }}
        run: |
          if [ -z "$ASUSTOR_USERNAME" ] || [ -z "$ASUSTOR_PASSWORD" ]; then
            echo "âš ï¸ Credentials not configured - manual upload required"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          SUCCESS=false
          for apk in apk/bin/*.apk; do
            if python3 scripts/devcenter-upload.py --apk "$apk" --verbose; then
              SUCCESS=true
            fi
          done
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT

      - name: Create issue if manual upload needed
        if: ${{ github.event_name == 'release' && steps.upload.outputs.success != 'true' }}
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ“¤ Upload v${{ steps.version.outputs.version }} to Dev Center"
          content-filepath: .github/ISSUE_TEMPLATE/dev-center-upload.md
          labels: release,needs-upload

      - name: Summary
        run: |
          echo "## ðŸ“¦ Dev Center Publication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-upload:** ${{ steps.upload.outputs.success == 'true' && 'âœ…' || 'âŒ Manual required' }}" >> $GITHUB_STEP_SUMMARY
