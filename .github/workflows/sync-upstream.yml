name: Sync Upstream

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update even if version matches'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  sync:
    name: Check & Update
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check versions
        id: check
        run: |
          # Current version
          CURRENT=$(python3 -c "import json; print(json.load(open('apk/CONTROL/config.json'))['general']['version'])")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          # Latest upstream
          DATA=$(curl -s https://api.github.com/repos/runtipi/runtipi/releases/latest)
          LATEST=$(echo "$DATA" | jq -r '.tag_name' | sed 's/^v//')
          URL=$(echo "$DATA" | jq -r '.html_url')
          echo "$DATA" | jq -r '.body' | head -50 > /tmp/notes.md
          
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Current: $CURRENT â†’ Latest: $LATEST"
          
          # Check if update needed
          if [ "${{ github.event.inputs.force }}" = "true" ] || \
             ([ "$CURRENT" != "$LATEST" ] && [ -n "$LATEST" ] && [ "$LATEST" != "null" ]); then
            # Check if tag already exists
            if git rev-parse "v$LATEST" >/dev/null 2>&1; then
              echo "update=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ Tag v$LATEST already exists"
            else
              echo "update=true" >> $GITHUB_OUTPUT
              echo "ðŸ”” Update available"
            fi
          else
            echo "update=false" >> $GITHUB_OUTPUT
            echo "âœ… Up to date"
          fi

      - name: Update files
        if: steps.check.outputs.update == 'true'
        run: |
          VERSION="${{ steps.check.outputs.latest }}"
          DATE=$(date +%Y-%m-%d)
          
          # Update config.json
          python3 << EOF
          import json
          with open('apk/CONTROL/config.json', 'r') as f:
              config = json.load(f)
          config['general']['version'] = '$VERSION'
          with open('apk/CONTROL/config.json', 'w') as f:
              json.dump(config, f, indent=4)
          EOF
          
          # Update changelog
          {
            head -1 apk/CONTROL/changelog.txt
            echo ""
            echo "## [$VERSION] - $DATE"
            echo "- Core: Runtipi v$VERSION release"
            echo ""
            tail -n +2 apk/CONTROL/changelog.txt
          } > /tmp/changelog.txt
          mv /tmp/changelog.txt apk/CONTROL/changelog.txt

      - name: Build packages
        if: steps.check.outputs.update == 'true'
        run: |
          python3 build/build.py
          python3 build/build-arm64.py
          cd apk/bin && sha256sum *.apk > checksums.sha256

      - name: Commit & tag
        if: steps.check.outputs.update == 'true'
        run: |
          VERSION="${{ steps.check.outputs.latest }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apk/CONTROL/config.json apk/CONTROL/changelog.txt
          git commit -m "chore: update to Runtipi v$VERSION"
          git push
          git tag -a "v$VERSION" -m "Runtipi $VERSION for ASUSTOR"
          git push origin "v$VERSION"

      - name: Create pre-release
        if: steps.check.outputs.update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.check.outputs.latest }}
          name: "ðŸ” [Review] Runtipi ${{ steps.check.outputs.latest }}"
          body: |
            ## âš ï¸ Pre-release - Review Required
            
            Automatically synced from upstream. Please test before publishing.
            
            **Upstream:** [${{ steps.check.outputs.latest }}](${{ steps.check.outputs.url }})
          draft: false
          prerelease: true
          files: |
            apk/bin/*.apk
            apk/bin/checksums.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ”„ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| | |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Current | ${{ steps.check.outputs.current }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest | ${{ steps.check.outputs.latest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Updated | ${{ steps.check.outputs.update }} |" >> $GITHUB_STEP_SUMMARY
