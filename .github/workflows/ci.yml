name: CI

on:
  push:
    branches: [main]
    paths:
      - 'apk/**'
      - 'scripts/**'
      - 'build/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================================================
  # LINT & VALIDATE
  # ============================================================================
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          echo "üîç Linting scripts..."
          shellcheck -s sh -e SC2039,SC2155,SC3037,SC3057,SC2086 \
            apk/CONTROL/*.sh scripts/*.sh 2>&1 || true

      - name: Check line endings
        run: |
          ERRORS=0
          for script in apk/CONTROL/*.sh scripts/*.sh; do
            if file "$script" | grep -q "CRLF"; then
              echo "‚ùå CRLF: $script"
              ERRORS=$((ERRORS + 1))
            fi
          done
          [ $ERRORS -eq 0 ] || exit 1
          echo "‚úÖ All scripts have Unix line endings"

      - name: Validate JSON
        run: |
          for json in apk/CONTROL/*.json; do
            jq . "$json" > /dev/null || { echo "‚ùå Invalid: $json"; exit 1; }
            echo "‚úÖ $json"
          done

      - name: Validate config.json
        run: |
          python3 << 'EOF'
          import json, re, sys
          config = json.load(open('apk/CONTROL/config.json'))
          g = config.get('general', {})
          
          errors = []
          if not re.match(r'^[a-z][a-z0-9]*(\.[a-z][a-z0-9]*)+$', g.get('package', '')):
              errors.append(f"Invalid package: {g.get('package')}")
          if g.get('architecture') not in ['x86-64', 'arm64', 'any']:
              errors.append(f"Invalid architecture: {g.get('architecture')}")
          
          if errors:
              for e in errors: print(f"‚ùå {e}")
              sys.exit(1)
          print(f"‚úÖ config.json valid (v{g.get('version')})")
          EOF

      - name: Check required files
        run: |
          for f in apk/CONTROL/config.json apk/CONTROL/icon.png apk/CONTROL/start-stop.sh \
                   apk/CONTROL/common.sh build/build.py; do
            [ -f "$f" ] && echo "‚úÖ $f" || { echo "‚ùå Missing: $f"; exit 1; }
          done

  # ============================================================================
  # BUILD (uses reusable workflow)
  # ============================================================================
  build:
    name: Build
    needs: lint
    uses: ./.github/workflows/build.yml

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [lint, build]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## üì¶ CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
